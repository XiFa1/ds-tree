<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Xmas Tree - Diagnostic Mode</title>
    <style>
        body { margin: 0; overflow: hidden; background-color: #020502; font-family: sans-serif; }
        #canvas-container { width: 100vw; height: 100vh; }
        #ui { position: absolute; top: 20px; left: 20px; color: #D4AF37; pointer-events: none; z-index: 10; }
        .btn { background: #b01b2e; color: white; padding: 8px 15px; border-radius: 20px; cursor: pointer; pointer-events: auto; display: inline-block; margin-top: 10px; }
    </style>
    
    <script>
        window.onerror = function(msg, url, lineNo, columnNo, error) {
            var log = document.getElementById('error-console');
            if (!log) {
                log = document.createElement('div');
                log.id = 'error-console';
                log.style.cssText = 'position:fixed; top:0; left:0; width:100%; background:rgba(0,0,0,0.9); color:#ff5555; z-index:9999; padding:20px; font-family:monospace; box-sizing:border-box; border-bottom: 2px solid red;';
                document.body.appendChild(log);
            }
            log.innerHTML += 'ğŸ”´ é”™è¯¯: ' + msg + '<br>ğŸ“ è¡Œå·: ' + lineNo + '<br>--------------------------<br>';
            return false;
        };
    </script>
</head>
<body>

    <div id="ui">
        <h1>è¯Šæ–­æ¨¡å¼ (Diagnostic Mode)</h1>
        <div>å°è¯•ç‚¹å‡»å±å¹•æˆ–æ‹–åŠ¨é¼ æ ‡</div>
        <label class="btn">ä¸Šä¼ å›¾ç‰‡<input type="file" id="upload" style="display:none" multiple></label>
    </div>

    <div id="canvas-container"></div>

    <script type="module">
        // ç›´æ¥å¼•ç”¨ elemecdn çš„ Three.js ä¸»æ–‡ä»¶ï¼Œä¸ä½¿ç”¨ä»»ä½•æ’ä»¶ï¼Œä¿è¯åŠ è½½æˆåŠŸç‡
        import * as THREE from 'https://npm.elemecdn.com/three@0.160.0/build/three.module.js';
        
        // å¼•å…¥ GSAP åŠ¨ç”»åº“
        import gsap from 'https://npm.elemecdn.com/gsap@3.12.2/index.js';

        // --- åˆå§‹åŒ–åœºæ™¯ ---
        const container = document.getElementById('canvas-container');
        const scene = new THREE.Scene();
        scene.fog = new THREE.FogExp2(0x020502, 0.02);

        const camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 0.1, 1000);
        camera.position.set(0, 5, 25);

        const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setPixelRatio(window.devicePixelRatio);
        container.appendChild(renderer.domElement);

        // --- ç¯å…‰ ---
        const ambientLight = new THREE.AmbientLight(0xffffff, 0.5);
        scene.add(ambientLight);
        const pointLight = new THREE.PointLight(0xD4AF37, 2, 50);
        pointLight.position.set(0, 10, 10);
        scene.add(pointLight);

        // --- ç®€å•çš„å‡ ä½•ä½“ (æ— éœ€åŠ è½½å¤–éƒ¨æ¨¡å‹) ---
        const particles = [];
        const geoSphere = new THREE.SphereGeometry(0.3, 16, 16);
        const geoBox = new THREE.BoxGeometry(0.5, 0.5, 0.5);
        const matGold = new THREE.MeshStandardMaterial({ color: 0xD4AF37, roughness: 0.3, metalness: 0.8 });
        const matRed = new THREE.MeshStandardMaterial({ color: 0xB01B2E, roughness: 0.5 });
        const matGreen = new THREE.MeshStandardMaterial({ color: 0x2F4F4F, roughness: 0.8 });

        const CONFIG = { count: 400 };

        // --- ç”Ÿæˆç²’å­ ---
        for (let i = 0; i < CONFIG.count; i++) {
            let mesh;
            if (Math.random() > 0.3) {
                mesh = new THREE.Mesh(geoSphere, Math.random() > 0.5 ? matGold : matGreen);
            } else {
                mesh = new THREE.Mesh(geoBox, matRed);
            }

            // è®¡ç®—ä½ç½®
            const y = (i / CONFIG.count) * 16 - 8; 
            const radius = (1 - (y + 8) / 16) * 6; 
            const angle = i * 2.4;
            
            mesh.userData = {
                treePos: { x: Math.cos(angle) * radius, y: y, z: Math.sin(angle) * radius },
                scatterPos: { x: (Math.random()-0.5)*30, y: (Math.random()-0.5)*30, z: (Math.random()-0.5)*20 }
            };

            mesh.position.set(mesh.userData.treePos.x, mesh.userData.treePos.y, mesh.userData.treePos.z);
            scene.add(mesh);
            particles.push(mesh);
        }

        // --- äº¤äº’çŠ¶æ€ ---
        let isTree = true;
        
        function toggleState() {
            isTree = !isTree;
            particles.forEach(p => {
                const target = isTree ? p.userData.treePos : p.userData.scatterPos;
                gsap.to(p.position, {
                    x: target.x, y: target.y, z: target.z,
                    duration: 1.5,
                    ease: "power2.inOut"
                });
                gsap.to(p.rotation, {
                    x: Math.random()*Math.PI, y: Math.random()*Math.PI,
                    duration: 1.5
                });
            });
        }

        // é¼ æ ‡ç‚¹å‡»è§¦å‘åˆ‡æ¢
        window.addEventListener('mousedown', toggleState);
        window.addEventListener('touchstart', toggleState);

        // --- åŠ¨ç”»å¾ªç¯ ---
        function animate() {
            requestAnimationFrame(animate);
            if(isTree) scene.rotation.y += 0.002;
            renderer.render(scene, camera);
        }
        
        // å¯åŠ¨
        animate();
        console.log("System Started");

        // --- å›¾ç‰‡ä¸Šä¼ é€»è¾‘ ---
        document.getElementById('upload').addEventListener('change', (e) => {
            alert("å›¾ç‰‡åŠŸèƒ½åœ¨ç®€åŒ–ç‰ˆä¸­æš‚æ—¶ç¦ç”¨ï¼Œç¡®è®¤ä¸»ç¨‹åºè¿è¡Œæ­£å¸¸åå†æ·»åŠ ã€‚");
        });

        // çª—å£è°ƒæ•´
        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });
    </script>
</body>
</html>
